function modalHidden(e){var t=e.find("section.modal");t.removeClass("modal-in"),t.css({display:"none"}),e.removeClass("active")}window.onerror=function(e,t,o,i,r){alert(e+"--"+t+"--"+o+"--"+i+"--"+r)};var GLOBAL={orderInfo:{},reqURL:{},photo:function(){},photos:[],proTypes:[]},Page={preInit:function(){},index:{},cart:{}};Utils={debounce:function(e,t,o){var i;return function(){var r=this,n=arguments,a=function(){i=null,o||e.apply(r,n)},s=o&&!i;clearTimeout(i),i=setTimeout(a,t),s&&e.apply(r,n)}},newGuid:function(e,t){function o(e){function t(e,t){if(t=t.replace(/\{|\(|\)|\}|-/g,""),t=t.toLowerCase(),32!=t.length||-1!=t.search(/[^0-9,a-f]/i))i(e);else for(var o=0;o<t.length;o++)e.push(t[o])}function i(e){for(var t=32;t--;)e.push("0")}function r(e,t){switch(t){case"N":return e.toString().replace(/,/g,"");case"D":var i=e.slice(0,8)+"-"+e.slice(8,12)+"-"+e.slice(12,16)+"-"+e.slice(16,20)+"-"+e.slice(20,32);return i=i.replace(/,/g,"");case"B":var i=r(e,"D");return i="{"+i+"}";case"P":var i=r(e,"D");return i="("+i+")";default:return new o}}var n=new Array;"string"==typeof e?t(n,e):i(n),this.Equals=function(e){return e&&e.IsGuid?this.ToString()==e.ToString():!1},this.IsGuid=function(){},this.ToString=function(e){return"string"==typeof e&&("N"==e||"D"==e||"B"==e||"P"==e)?r(n,e):r(n,"D")}}for(var e=e||"",i=t||32;i--;)e+=Math.floor(16*Math.random()).toString(16);return new o(e)},refreshStringArr:function(e){if(!e)return!1;var t=[],o=0;for(var i in e)e[i]&&(t[i]=e[i],o++);return t.length=o,t},objectToXml:function(e){var t="";for(var o in e)switch(o){case"PageModel":case"LayerModel":case"Point":t+=this.objectToXml(e[o]);break;case"Layers":case"Pages":case"Points":t+="<"+o+">";for(var i in e[o])if(e[o][i].length)for(var r=0;r<e[o][i].length;r++)t+="<"+i+">"+this.objectToXml(e[o][i][r])+"</"+i+">";else t+="<"+i+">"+this.objectToXml(e[o][i])+"</"+i+">";t+="</"+o+">";break;case"xmlns:xsi":case"xmlns:xsd":break;default:t+="<"+o+">"+e[o]+"</"+o+">"}return t},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},objectToUrlpms:function(e){var t="?";for(var o in e)t+=o+"="+e[o]+"&";return t.substring(0,t.length-1)},rgbToHex:function(e){function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return rgb=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),rgb="#"+t(rgb[1])+t(rgb[2])+t(rgb[3])},setCookie:function(e,t,o){var i=new Date;i.setTime(i.getTime()+24*o*60*60*1e3),document.cookie=e+"="+escape(t)+";expires="+i.toGMTString()},getCookie:function(e){var t,o=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(o))?t[2]:""},delCookie:function(e){var t=new Date;t.setTime(t.getTime()-1);var o=getCookie(e);""!=o&&(document.cookie=e+"="+o+";expires="+t.toGMTString())},getUrlQuery:function(e,t){var o=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=e.substring(e.indexOf("?")+1).match(o);return null!=i?unescape(i[2]):null},checkPicZize:function(e,t,o,i){return e=parseInt(e,10),t=parseInt(t,10),o=parseInt(o,10),i=parseInt(i,10),0 in[e,t,o,i]?void console.log("warn: one size is 0!"):e>o&&t>i?e/2>o&&t/2>i?-1:0:1}},GLOBAL.orderInfo={orderID:"",proID:0,tplID:null,tplXmlUrl:"",tplSize:{w:0,h:0},typeName:"",typeID:null,pageCount:3,currPage:0,pageTotal:0,taobao:Utils.getCookie("taobao"),total:0,isNew:!0,editUrl:""},GLOBAL.reqURL={root:"http://api.inguu.com",getStyleURL:"http://api.inguu.com/Mould/GetTypeList?typeclass=2",getTplsURL:"http://api.inguu.com/Mould/getlist",ttfURL:"http://api.inguu.com/font/GetList",getFontPicURL:"http://api.inguu.com/font/GetFontPic",proxyURL:"/tool/ProxyXml",picSubURL:"/photo/UploadPhoto",orderSubURL:"/Photo/UploadOrder",imgSrc:"/Temp/"},GLOBAL.Photo=function(e){e&&e.length&&(this.guid=e.guid,this.state=e.state,this.param=e.param,this.goods=e.goods,this.number=e.number,this.imageWidth=e.imageWidth,this.imageHeight=e.imageHeight,this.orderID=e.orderID)},GLOBAL.photos=[];var PageTransition={defauts:{pageOutCls:"page-out",pageInCls:"page-in",activeCls:"page-active",nextPageCls:"page-next",prevPageCls:"page-prev",nextSelector:"header .btn-next-page",prevSelector:"header .btn-prev-page",pageSelector:"section.page",prevHandler:function(){},nextHandler:function(){}},init:function(){this.pageSlideOver(),this.addEvents()},pageSlideOver:function(){var e=this.defauts;$("."+e.pageOutCls).on("transitionend",function(){$(this).removeClass(e.pageOutCls)}),$("."+e.pageInCls).on("transitionend",function(){$(this).removeClass(e.pageInCls)})},nextPage:function(e){var t=this.defauts,e=e,o=e.next(t.pageSelector),i=o.data("role");e.removeClass(t.activeCls).addClass(t.prevPageCls+" "+t.pageOutCls),o.removeClass(t.nextPageCls).addClass(t.activeCls+" "+t.pageInCls),history.pushState({page:i},"","?page="+i),t.nextHandler&&t.nextHandler(e,o)},prevPage:function(e){var t=this.defauts,e=e,o=e.prev(t.pageSelector);e.removeClass(t.activeCls).addClass(t.nextPageCls+" "+t.pageOutCls),o.removeClass(t.prevPageCls).addClass(t.activeCls+" "+t.pageInCls),history.go(-1),t.prevHandler&&t.prevHandler(e,o)},addEvents:function(){var e=this.defauts,t=this;$(e.nextSelector).on("click",function(){t.nextPage($(this).parents(e.pageSelector))}),$(e.prevSelector).on("click",function(){t.prevPage($(this).parents(e.pageSelector))})}};$.pageTransition=PageTransition;var PullRefresh=function(e,t){this.$ele=$(e),this.options=t,this.$wrapper=this.$ele,this.$scroller=this.$wrapper.find(t.scrollerCls),this.$upEl=this.$wrapper.find(t.pullUpCls),this.$downEl=this.$wrapper.find(t.pullDownCls),this.$list=this.$wrapper.find(t.listBoxCls),this.iScrollObj=null,this.upNum=this.downNum=0,this.isPullUp=!1,this.loadingStep=0,this.init()};PullRefresh.prototype={constructor:PullRefresh,init:function(){this.iScrollObj=new IScroll(this.$wrapper[0],{probeType:2,scrollbars:!0,mouseWheel:!0,fadeScrollbars:!0,bounce:!0,interactiveScrollbars:!0,shrinkScrollbars:"scale",click:!0,keyBindings:!0,momentum:!0}),this.addEvents(this)},addEvents:function(e){e.iScrollObj.on("scroll",function(){e.crollEvent.bind(this)(e)}),e.iScrollObj.on("scrollEnd",function(){e.scrollEndEvent.bind(this)(e)})},crollEvent:function(e){e.loadingStep||(this.y>20&&e.options.canPullDown?(e.$downEl.show().html('<span class="mui-icon mui-icon-spinner-cycle mui-spin"></span> 释放更新'),e.loadingStep=1,e.isPullUp=!1,e.iScrollObj.refresh()):this.y<this.maxScrollY-20&&e.options.canPullUp&&(e.$upEl.show().html('<span class="mui-icon mui-icon-spinner-cycle mui-spin"></span> 释放更新'),e.loadingStep=1,e.isPullUp=!0,e.iScrollObj.refresh()))},scrollEndEvent:function(e){1===e.loadingStep&&(e.isPullUp&&e.options.canPullUp?(e.$upEl.html('<span class="mui-icon mui-icon-spinner-cycle mui-spin"></span> 正在加载...'),e.loadingStep=2,e.options.onPullUp(e)):e.options.canPullDown&&(e.$downEl.html('<span class="mui-icon mui-icon-spinner-cycle mui-spin"></span> 正在加载...'),e.loadingStep=2,e.options.onPullDown(e)))},refresh:function(){this.iScrollObj.refresh()}},$.fn.pullRefresh=function(e){return this.each(function(){var t=$(this),o=$.extend({},$.fn.pullRefresh.DEFAULTS,t.data(),"object"==typeof e&&e),i=$(this).data("lt.pullRefresh");i||t.data("lt.pullRefresh",i=new PullRefresh(this,o)),"string"==typeof e&&i[e]()})},$.fn.pullRefresh.DEFAULTS={scrollerCls:".scrollWrapper",pullUpCls:".pullUp",pullDownCls:".pullDown",canPullUp:!0,canPullDown:!1,listBoxCls:".list",onPullUp:function(){alert("默认函数")},onPullDown:function(){alert("默认函数")}},$.msg={},$.msg.alert=function(e,t,o,i){var r=$(t),n=r.find(".con"),a=r.find(".close"),s=i||"blue";"1"==r.data("isShown")?(clearTimeout(n.timmer),n.removeClass("flash").css("-webkit-animation-delay","0s"),n.timmer=setTimeout(function(){n.addClass("flash")},300)):(n.text(e||""),r.addClass(s).show().removeClass("fadeOutRight").addClass("fadeInRight"),n.addClass("flash").css("-webkit-animation-delay","1s"),o&&$.isNumeric(o)&&(clearTimeout(r.timmer),r.timmer=setTimeout(function(){r.removeClass("fadeInRight").addClass("fadeOutRight"),n.removeClass("flash"),r.data("isShown","0")},o)),a.off().on("click",function(){clearTimeout(r.timmer),r.removeClass("fadeInRight").addClass("fadeOutRight"),n.removeClass("flash"),r.data("isShown","0")}),r.data("isShown","1"))};var ColorPicker=function(e,t){this.$el=$(e),this.o=t,this.$title=this.$el.find(".title"),this.$canvas=this.$el.find(".cav_picker"),this.$cancel=this.$el.find(".cancel"),this.$confirm=this.$el.find(".confirm"),this.cRGB="",this.c16="",this.init()};ColorPicker.DEFAULTS={colorBgSrc:"/images/colorwheel.png",selectors:{title:".title",canvas:".cav_picker",btnCancel:".cancel",btnCancel:".confirm"},isShown:!1,currColor:"#000000",onCancel:function(){},onConfirm:function(){}},ColorPicker.prototype={constructor:ColorPicker,init:function(){this.$title.css({color:this.o.currColor,"border-color":this.o.currColor});var e=this.$canvas[0].getContext("2d"),t=new Image;t.src=this.o.colorBgSrc,t.onload=function(){e.drawImage(t,0,0,200,200)},this.addEvents(e),this.$el.fadeIn(),this.o.isShown=!0},hide:function(){this.$el.hide(),this.o.isShown=!1},show:function(){this.$el.fadeIn()},_changeColor:function(e,t){e.preventDefault();var o,i;o=e.touches[0].pageX,i=e.touches[0].pageY;var r=this.$canvas.offset(),n=Math.floor(o-r.left),a=Math.floor(i-r.top),s=t.getImageData(n,a,1,1),l=s.data,c="rgb("+l[0]+", "+l[1]+", "+l[2]+")",d="#"+("0000"+(l[2]+256*l[1]+65536*l[0]).toString(16)).substr(-6);this.$title.css({color:d,"border-color":d}),this.$canvas.data("val",d),this.cRGB=c,this.c16=d,this.o.currColor=d},addEvents:function(e){var t=this;this.$canvas[0].addEventListener("touchmove",function(o){t._changeColor.bind(t,o,e)()},!1),this.$cancel.on("click",function(){t.$el.hide(),t.o.onCancel&&t.o.onCancel(t.o.currColor)}),this.$confirm.on("click",function(){t.$el.hide(),t.o.onConfirm&&t.o.onConfirm(t.o.currColor)})}},$.fn.colorPicker=function(e){this.each(function(){var t=$(this),o=$.extend({},ColorPicker.DEFAULTS,"object"==typeof e&&e),i=t.data("color-picker");i||t.data("color-picker",i=new ColorPicker(this,o)),"string"==typeof e?i[e]():o.isShown||i.show()})},Page.preInit=function(){var e=window.location.href,t=PRO_INFO.id;if(!t)return $.msg.alert("请求地址错误！","#alert-box",4e3,"red"),!1;GLOBAL.orderInfo={orderID:Utils.newGuid().ToString("D"),proID:t,tplID:null,tplXmlUrl:"",tplSize:{w:2e3,h:2e3},typeName:"",typeID:31,pageCount:3,currPage:0,pageTotal:0,taobao:Utils.getCookie("taobao"),total:0,isNew:!0,editUrl:e};var o=$("#style-chk-box"),i=$("#tpl-list"),r=$("#tpl-chk-box"),n=$("#choiceInfo"),a=!0,s=function(){n.text("模板："+(GLOBAL.orderInfo.typeName||"无")+" - "+(GLOBAL.orderInfo.tplID||"无"))},l=function(){r.pullRefresh({onPullUp:function(e){var t=GLOBAL.orderInfo.typeID,o=GLOBAL.orderInfo.currPage,r=GLOBAL.orderInfo.pageTotal,n=GLOBAL.orderInfo.pageCount;if(r>=o){o++;var a="?orderid="+GLOBAL.orderInfo.proID+"&start="+o+"&limit="+n+"&typeid="+t,s=GLOBAL.reqURL.getTplsURL+a;console.log("更新："+s),$.post(GLOBAL.reqURL.proxyURL,c,function(e){var t=$.xml2json(e);console.log(t)}),$.ajax({url:GLOBAL.reqURL.proxyURL,type:"POST",data:{url:s},success:function(t){GLOBAL.orderInfo.currPage=o;var r=$.xml2json(t),n=r.count;if(n>0&&r.mould){var a=r.mould,s=[];if(a.length)for(var l=0,c=a.length;c>l;l+=1)s.push("<li data-tplid="+a[l].id+" data-xmlurl="+a[l].xmlurl+'><img src="'+a[l].picurl+'" alt="模板预览"></li>');else s.push("<li data-tplid="+a.id+" data-xmlurl="+a.xmlurl+'><img src="'+a.picurl+'" alt="模板预览"></li>');i.append(s.join("")),Utils.debounce(function(){e.iScrollObj.refresh()},400,!1)()}else e.$upEl.html("没有更多了...")},error:function(){e.$upEl.html('<span class="mui-icon mui-icon-close"></span> 网络错误，数据加载失败！')}})}else e.$upEl.html("没有更多了...");var l="?orderid=25&start=1&limit=2",c={url:GLOBAL.reqURL.getTplsURL+l};$.post(GLOBAL.reqURL.proxyURL,c,function(e){var t=$.xml2json(e);console.log(t)}),e.$upEl.html('<span class="mui-icon mui-icon-arrowthinup"></span> 上拉显示更多...'),e.iScrollObj.refresh(),e.loadingStep=0}})},c=function(){var e=$(this),t=$("#pullUp");t.hide(),i.html('<div class="loading-tpl c-888" ><img src="/images/loading1.gif" alt="">  加载中···</div>'),void 0!==o.data("chkedIndx")&&o.children().eq(o.data("chkedIndx")).removeClass("active"),o.data("chkedIndx",$(this).index()),$(this).addClass("active");var n=$(this).data("styleid");GLOBAL.orderInfo.typeID=n,GLOBAL.orderInfo.tplID=null,GLOBAL.orderInfo.currPage=0,GLOBAL.orderInfo.typeName=e.text(),s();var c=GLOBAL.reqURL.getTplsURL+"?orderid="+GLOBAL.orderInfo.proID+"&typeid="+n+"&start=0&limit="+GLOBAL.orderInfo.pageCount;console.log(c),$.post(GLOBAL.reqURL.proxyURL,{url:c},function(o){var n=$.xml2json(o);console.log(n);var s=n.count;if(e.data("total",s),GLOBAL.orderInfo.pageTotal=s&&parseInt(Math.ceil(s/GLOBAL.orderInfo.pageCount)),console.log(GLOBAL.orderInfo),s>0){t.show();var c=n.mould,d=[];if(c.length){for(var p=0,u=c.length;u>p;p+=1)d.push("<li data-tplid="+c[p].id+" data-xmlurl="+c[p].xmlurl+'><img src="'+c[p].picurl+'" alt="模板预览"></li>');c.length<3&&t.hide()}else d.push("<li data-tplid="+c.id+" data-xmlurl="+c.xmlurl+'><img src="'+c.picurl+'" alt="模板预览"></li>'),t.hide();i.html(d.join("")),a?(l(),a=!1):Utils.debounce(function(){r.pullRefresh("refresh")},400,!1)()}else i.html('<p class="mui-text-center c-888 f30" style="line-height:300px">敬请期待...</p>'),a||Utils.debounce(function(){r.pullRefresh("refresh")},300,!1)(),t.hide(),GLOBAL.orderInfo.tplID=null,console.log(GLOBAL.orderInfo)})},d=function(){var e=$(this),t=e.data("tplid");void 0!==i.data("chkedIndex")&&i.children().eq(i.data("chkedIndex")).removeClass("active"),e.addClass("active"),i.data("chkedIndex",e.index()),GLOBAL.orderInfo.tplID=t,GLOBAL.orderInfo.tplXmlUrl=e.data("xmlurl"),s(),console.log(GLOBAL.orderInfo)};o.delegate("li","click",c),i.delegate("li","click",d);var p={url:GLOBAL.reqURL.getStyleURL};$.ajax({url:GLOBAL.reqURL.proxyURL,type:"POST",data:p,async:!1,success:function(e){var t=$.xml2json(e);if(console.log(t),t.mouldtype&&t.mouldtype.length){var i=t.mouldtype,r=[],n=i.length-1;for(i.length;n>=0;n--)r.push("<li data-styleid="+i[n].id+'><a href="javascript:void(0)">'+i[n].typename+"</a></li>");if(o.append(r.join("")),i.length>3){o.css("width",o.children().first().outerWidth(!0)*i.length);{new IScroll("#style-wrapper",{scrollX:!0,scrollY:!1,snap:"li",momentum:!1,click:!0})}}o.children().eq(0).trigger("click")}}}),$("#view-page-index")[0].addEventListener("touchmove",function(e){e.preventDefault()},!1),$("#tpls-box")[0].addEventListener("touchmove",function(e){e.preventDefault()},!1),GLOBAL.orderInfo_temp=$.extend({},GLOBAL.orderInfo)},Page.index={init:function(){$("#style-chk-box li:first").click()}},Page.cart={options:{taobaoBox:$("#cart-taobao"),picListBox:$("#pic-list-box"),isFirstInit:!0,currXmlUrl:"",currPageNum:0,currPageScale:0,models:{},tplXMLData:{},textLayerInfo:{},ttfPicList:[],imgPosInfo:[]},init:function(){var e=this.options;e.isFirstInit&&(e.taobaoBox.text(GLOBAL.orderInfo.taobao),this.uploadPic(),this.reChoiceTplEv(),this.editUserEv(),this.subOrderEv(),this.tplNavPageEv(),this.picListActionEV(),this.popupAddTextEv(),e.isFirstInit=!1),this.initTpl()},initTpl:function(){var e=this.options;e.currXmlUrl!=GLOBAL.orderInfo.tplXmlUrl&&(e.currXmlUrl=GLOBAL.orderInfo.tplXmlUrl,$.post(GLOBAL.reqURL.proxyURL,{url:GLOBAL.orderInfo.tplXmlUrl},function(t){var o=$.xml2json(t);e.tplXMLData=o,e.imgPosInfo=[],console.log(o);var i=o.ModelWidth,r=o.ModelHeight,n=o.Pages||{};if(!n)return!1;GLOBAL.tplSize.w=i,GLOBAL.tplSize.h=r;var a=e.models=n.PageModel,s=a;if(a.length){s=a[0];var l,c=[];c.push('<div class="mui-clearfix">');for(var d=1,p=a.length;p>=d;d+=1){if(1!==d&&(d-1)%5===0)c.push('</div><div class="mui-clearfix hide">');else if(d===p&&d%5!==0){c.push('<a href="javascript:void(0)" >'+d+"</a></div>");break}l=1===d?"active":"",c.push('<a href="javascript:void(0)" class="'+l+'" >'+d+"</a>")}$("#tpl-navpage div.pagenum").html(c.join("")).data("currPageNumLayer",0),$("#tpl-navpage").show()}{var u=s.Back;s.TextLayers}$("#tpls-box").data("currindex",0).children().first().nextAll().remove();var f=$("#tpl-edit-box0");f.show().children().remove();var h=document.body.clientHeight-44-41-84-28-32-20,g=document.body.clientWidth-20;e.currPageScale=parseInt(i,10)>=parseInt(r,10)?g/i:h/r,f.css({position:"relative",background:"url("+GLOBAL.reqURL.root+u+") no-repeat center center","background-size":"100%",width:i,height:r,zoom:e.currPageScale,left:"50%","margin-left":-i/2});var m,v,L,x,I,b,y,C,P,w,O=s.Layers.LayerModel;if(O){Utils.isArray(O)||(O=[].push(O));for(var d=0,p=O.length;p>d;d+=1)m=O[d].Width,v=O[d].Height,L=O[d].Index,x=O[d].IsPhoto,I=O[d].IsRotate,b="rotate("+O[d].Rotate+"deg)",y=O[d].X,C=O[d].Y,P=O[d].Src,w=O[d].Index,P&&(P=GLOBAL.reqURL.root+P),"false"==x?$('<img src="'+P+'" alt="素材图片" data-index="'+w+'" width="'+m+'" height="'+v+'" />').css({position:"absolute",left:y+"px",top:C+"px",zIndex:L,transform:b}).appendTo(f):$('<div class="drop-box" data-index="'+w+'"><p style="margin-top:25%; color:#fff;">请拖动图片到此处</p></div>').css({position:"absolute",backgroundColor:"rgb(168, 168, 168)",color:"#fff",textAlign:"center",left:y+"px",top:C+"px",zIndex:L,transform:b,width:m+"px",height:v+"px"}).data("boxsize",{w:m,h:v}).appendTo(f)}$("#loading-tpl").hide()}))},tplNavPageEv:function(){var e=$("#tpl-navpage"),t=$("#tpls-box"),o=e.find(".pagenum"),i=this.options;e.on("click","a",function(){var e=i.models;if(!e||!e.length)return!1;var o=$(this),r=parseInt(o.text(),10)-1,n=e[r],a=n.Layers.LayerModel;if(i.currPageNum=r,0==$("#tpl-edit-box"+r).length){t.append('<div class="tpl-edit-box" id="tpl-edit-box'+r+'" ></div>');var s=$("#tpl-edit-box"+r),l=n.Back,c=(n.TextLayers,n.Width),d=n.Height,p=document.body.clientHeight-44-41-84-28-32-20,u=document.body.clientWidth-20;if(i.currPageScale=parseInt(c,10)>=parseInt(d,10)?u/c:p/d,s.css({position:"relative",background:"url("+GLOBAL.reqURL.root+l+") no-repeat center center","background-size":"100%",width:c,height:d,zoom:i.currPageScale,left:"50%","margin-left":-c/2}),Utils.isArray(a))for(var f,h,g,m,v,L,x,I,b,y,C=0,P=a.length;P>C;C+=1)f=a[C].Width,h=a[C].Height,g=a[C].Index,m=a[C].IsPhoto,v=a[C].IsRotate,L="rotate("+a[C].Rotate+"deg)",x=a[C].X,I=a[C].Y,b=a[C].Src,y=a[C].Index,b&&(b=GLOBAL.reqURL.root+b),"false"==m?$('<img src="'+b+'" alt="素材图片" data-index="'+y+'" width="'+f+'" height="'+h+'" />').css({position:"absolute",left:x+"px",top:I+"px",zIndex:g,transform:L}).appendTo(s):$('<div class="drop-box" data-index="'+y+'"><p style="margin-top:25%; color:#fff;">请拖动图片到此处</p></div>').css({position:"absolute",backgroundColor:"rgb(168, 168, 168)",color:"#fff",textAlign:"center",left:x+"px",top:I+"px",zIndex:g,transform:L,width:f+"px",height:h+"px"}).data("boxsize",{w:f,h:h}).appendTo(s);else f=a.Width,h=a.Height,g=a.Index,m=a.IsPhoto,v=a.IsRotate,L="rotate("+a.Rotate+"deg)",x=a.X,I=a.Y,b=a.Src,y=a.Index,$('<div class="drop-box" data-index="'+y+'"><p style="margin-top:25%; color:#fff;">请拖动图片到此处</p></div>').css({position:"absolute",backgroundColor:"rgb(168, 168, 168)",color:"#fff",textAlign:"center",left:x+"px",top:I+"px",zIndex:g,transform:L,width:f+"px",height:h+"px"}).data("boxsize",{w:f,h:h}).appendTo(s)}$("#tpl-edit-box"+t.data("currindex")).hide(),$("#tpl-edit-box"+r).show(),t.data("currindex",r),o.hasClass("active")||o.addClass("active")}),e.find("button.prev").on("click",function(){var e=o.data("currPageNumLayer"),t=o.children();0!==e?($(this).removeClass("disable"),t.eq(e).hide(),e--,o.data("currPageNumLayer",e),t.eq(e).show()):$(this).addClass("disable")}),e.find("button.next").on("click",function(){var e=o.data("currPageNumLayer"),t=o.children(),i=t.length-1;e!==i?($(this).removeClass("disable"),t.eq(e).hide(),e++,o.data("currPageNumLayer",e),t.eq(e).show()):$(this).addClass("disable")})},uploadPic:function(){function e(){if(c.length){var e=c.shift();o(e)}else{if(console.log("所有文件上传完毕！"),c.length=0,l.refreshPicListPos(),l.initDrag(),$("#pic-list-box").children().length>4){var t=$("#upload-pic-actions");t.find(".next").removeAttr("disabled"),t.find(".delete").removeAttr("disabled")}$("#loading-box").css("display","none").removeClass("colorful-pulse")}}function t(){console.log("选择的文件个数："+this.files.length),c=[].slice.call(this.files),c=r(c),i(c),c.length&&e(),this.value=""}function o(e){var t="?guid="+e.guid+"&name="+encodeURIComponent(GLOBAL.orderInfo.taobao),o=e.guid,i=new XMLHttpRequest;i.upload.addEventListener("progress",n,!1),i.addEventListener("load",function(t){a(t,o,e.sizeOK)},!1),i.addEventListener("loadstart",function(){$("#loading-box").css("display","block").find("span").css("-webkit-animation-play-state","running")},!1),i.addEventListener("error",s,!1),i.open("POST",GLOBAL.reqURL.picSubURL+t,!0);var r=new FormData;r.append("file",e),i.send(r)}function i(e){if(e&&"[object Array]"===toString.call(e)&&e.length)for(var t=0,o=e.length;o>t;t+=1){var i=Utils.newGuid().ToString("D");e[t].guid=i}}function r(e){for(var t,o=[],i=0;t=e[i];i++)t.size>=104857600?$.msg.alert("您这张"+t.name+"图片过大，应小于100M","#alert-box",4e3):o.push(t);return o}function n(e){if(e.lengthComputable){var t=e.loaded/e.total;console.log("进度："+Math.floor(100*t)+"%")}}function a(t,o){$("#cart-temp-info")&&$("#cart-temp-info").remove();var i=t.target.responseText;if(i.indexOf("|")>0){var r=i.split("|"),n=r[0],a=r[1],s=$("#pic-list-box"),l="";if(!GLOBAL.tplSize.w||!GLOBAL.tplSize.h)return console.log("未获取到模板大小"),!1;switch(Utils.checkPicZize(GLOBAL.tplSize.w,GLOBAL.tplSize.h,n,a)){case 0:l="warn";break;case 1:l="normal";break;case-1:l="error"}$('<li id="list'+o+'"></li>').css({"background-image":"url("+GLOBAL.reqURL.imgSrc+encodeURIComponent(GLOBAL.orderInfo.taobao).replace(/\%/g,"_")+"/x_"+o+".jpg)"}).data("size",{w:n,h:a}).append('<span class="'+l+'"></span>').appendTo(s),s.data("currPage",0);var c=new GLOBAL.Photo({guid:o,state:1,goods:GLOBAL.orderInfo.tplID,number:1,imageWidth:r[0],imageHeight:r[1],length:11,orderID:GLOBAL.orderInfo.orderID});GLOBAL.photos[o]=c,GLOBAL.photos.length=(GLOBAL.photos.length||0)+1,console.log(GLOBAL.photos)}else $.msg.alert("请检查旺旺名称，文件上传失败 :(","#alert-box",4e3);e()}function s(e){$("#loading-box").css("display","none").find("span").css("-webkit-animation-play-state","paused"),$.msg.alert("文件上传出错: "+e.target.error,"#alert-box",4e3,"red")}var l=this,c=[];$("#file-image").on("change",t)},refreshPicListPos:function(){var e=0;$("#pic-list-box li:visible").each(function(){$(this).css({top:"4px",left:70*e+3+"px"}),e++})},picListActionEV:function(){var e=$("#pic-list-box"),t=$("#upload-pic-actions");self=this,t.find(".prev").on("click",function(){var t=e.data("currPage"),o=e.children();if(0===t)return!1;t--;var i=4*t,r=4*(t+1);o.hide().slice(i,r).show(),self.refreshPicListPos(),0===t&&$(this).attr("disabled","disabled"),$(this).siblings().removeAttr("disabled"),e.data("currPage",t)}),t.find(".next").on("click",function(){var t=e.data("currPage"),o=e.children();if(4*(t+1)>=o.length)return!1;t++;var i=4*t,r=4*(t+1);o.hide().slice(i,r).show(),self.refreshPicListPos(),e.data("currPage",t),4*(t+1)>=o.length&&$(this).attr("disabled","disabled"),$(this).siblings().removeAttr("disabled")}),t.find(".delete").on("click",function(){window.confirm("确认清空所有已经上传的照片吗？")&&(e.html('<li id="cart-temp-info" class="c-888 f30">请上传您的相片！</li>'),t.hide())})},initDrag:function(){var e=this,t=this.options;$("#pic-list-box li").pep({constrainTo:"#view-page-cart",droppable:".drop-box",droppableActiveClass:"pep-dpa",overlapFunction:!1,useCSSTranslation:!1,revert:!0,revertIf:function(){return!this.activeDropRegions.length},start:function(e,t){t.noCenter=!1,t.$el.css("z-index",99)},drag:function(){},rest:function(o,i){if(i.activeDropRegions.length>0){var r=$(i.el),n=r.css("background-image"),a=r.data("size"),s=r.prop("id").substring(4);n=n.substring(4,n.length-1),i.revert();var l=$(i.activeDropRegions[0]),c=l.data("index"),d=Math.random().toString("16").substring(2,5);l.html("").css({overflow:"hidden"});var p=l.data("boxsize"),u=e.autoScaleImg(p.w,p.h,a.w,a.h);$('<img id="i'+s+d+'" src="'+n+'" class="" alt="" width="'+a.w+'" height="'+a.h+'"/>').css({width:u.w,height:u.h}).appendTo(l);var f=l.parents(".tpl-edit-box").prop("id").replace("tpl-edit-box","");t.imgPosInfo["i-"+f+"-"+c]={Src:encodeURIComponent(GLOBAL.orderInfo.taobao).replace(/%/g,"_")+"/"+s+".jpg",ImageX:0,ImageY:0,ImageWidth:u.w,ImageHeight:u.h,BaseWidth:a.w,BaseHeight:a.h};var h=0;for(var g in t.imgPosInfo)h+=1;t.imgPosInfo.length=h;{var m=l;m.offset().top,m.offset().left}$("#i"+s+d).pep({isBoxZoom:!0,seCSSTranslation:!1,axis:u.cmx?"x":"y",drag:function(e,o){var i=o.$el.css("transform");if(i){var r=i.substring(7,i.length-1).replace(/\s+/g,"").split(",");t.imgPosInfo["i-"+f+"-"+c].ImageX=r[4],t.imgPosInfo["i-"+f+"-"+c].ImageY=r[5]}else t.imgPosInfo["i-"+f+"-"+c].ImageX=t.imgPosInfo["i-"+c].ImageY=0;console.log(t.imgPosInfo)}})}}})},initImgScroll:function(){},reChoiceTplEv:function(){$("#reChoiceTpl").on("click",function(){$.pageTransition.prevPage($("#view-page-cart"))})},autoScaleImg:function(e,t,o,i){var r={w:0,h:0,cmx:!1};return o/i>e/t?(r.h=t,r.w=o*t/i,r.cmx=!0):(r.w=e,r.h=i*e/o),r},editUserEv:function(){var e=$("#dialog-editTB");$("#cart-taobao").on("click",function(){e.addClass("active");var t=e.find("section.modal");t.css({display:"block"}),setTimeout(function(){t.addClass("modal-in")},100),$("#txt_editTB").val(GLOBAL.orderInfo.taobao).focus()}),e.find(".btn-cancel").on("click",function(){modalHidden(e)}),e.find(".btn-primary").on("click",function(){var t=$.trim($("#txt_editTB").val());""!==t?(GLOBAL.orderInfo.taobao=t,Utils.setCookie("taobao",t,30),$("#cart-taobao").text(t),modalHidden(e)):$("#txt_editTB").addClass("ipt-error flash-anim")}),e.click(function(t){t.target.classList.contains("overlay")&&modalHidden(e)})},buildSubData:function(){var e,t=this.options,o=this.options.tplXMLData,i=this.options.imgPosInfo,r=o.Pages.PageModel,n=0,a=r.length,s="";if(!Utils.isArray(r)){var l=r;r=[],r.push(l)}for(a=r.length;a>n;n+=1){if(e=r[n].Layers.LayerModel,Utils.isArray(e))for(var c=0,d=e.length;d>c;c+=1)if("true"==e[c].IsPhoto){var p=e[c].Index;if(!i["i-"+n+"-"+p])continue;e[c].Src=i["i-"+n+"-"+p].Src,e[c].Type="photo",e[c].ImageX=i["i-"+n+"-"+p].ImageX,e[c].ImageY=i["i-"+n+"-"+p].ImageY,e[c].ImageWidth=i["i-"+n+"-"+p].ImageWidth,e[c].ImageHeight=i["i-"+n+"-"+p].ImageHeight,e[c].BaseWidth=i["i-"+n+"-"+p].BaseWidth,e[c].BaseHeight=i["i-"+n+"-"+p].BaseHeight}else e[c].Type=e[c].IsText?"text":"icon";else{var l=e;r[n].Layers.LayerModel=[],r[n].Layers.LayerModel.push(e);var u=r[n].Layers.LayerModel;if("true"===u[0].IsPhoto){var p=u[0].Index;if(!i["i-"+n+"-"+p])continue;u[0].Src=i["i-"+n+"-"+p].Src,u[0].Type="photo",u[0].ImageX=i["i-"+n+"-"+p].ImageX,u[0].ImageY=i["i-"+n+"-"+p].ImageY,u[0].ImageWidth=i["i-"+n+"-"+p].ImageWidth,u[0].ImageHeight=i["i-"+n+"-"+p].ImageHeight,u[0].BaseWidth=i["i-"+n+"-"+p].BaseWidth,u[0].BaseHeight=i["i-"+n+"-"+p].BaseHeight}else e[0].Type=e[0].IsText?"text":"icon"}if(t.textLayerInfo.length)for(var f in t.textLayerInfo)n==f.substring(f.indexOf("-")+1,f.lastIndexOf("-"))&&e.push(t.textLayerInfo[f])}console.log(e);var h="<Product>"+GLOBAL.orderInfo.proID+"</Product><ModelID>"+GLOBAL.orderInfo.tplID+"</ModelID><Param></Param>";s="<Book>"+Utils.objectToXml(o)+h+"</Book>",console.log(s);var g={name:GLOBAL.orderInfo.typeName,taobao:GLOBAL.orderInfo.taobao,order:encodeURIComponent(s),editID:"",editUrl:GLOBAL.orderInfo.editUrl};return g},subOrderEv:function(){{var e=this;this.options}$("#sub-order-btn").on("click",function(){if($(".drop-box img").length!=$(".drop-box").length)return $.msg.alert("请给模板添加照片！","#alert-box",4e3,"red"),!1;var t=e.buildSubData();return t?($.post(GLOBAL.reqURL.orderSubURL,t,function(t){console.log(t),t.indexOf("|")>0?($.msg.alert("订单提交成功！EditID="+t.split("|")[1],"#alert-box",4e3,"green"),e.resetCartList(),e.resetOrderInfo(),Page.index.init()):$.msg.alert("订单提交失败："+t.substring(0,20),"#alert-box",4e3,"red")}),!1):!1})},resetCartList:function(){$("#pic-list-box").html('<li id="cart-temp-info" class="c-888 f30">请上传您的相片！</li>'),$("#tpls-box").find(".txtImg").remove(),this.options.textLayerInfo={},this.options.imgPosInfo=[],$(".drop-box").html("").html('<p style="margin-top:25%; color:#fff;">请拖动图片到此处</p>');var e=$("#tpl-navpage");e.find("a:not(:first)").removeClass("active"),e.find(".pagenum div").hide().first().show()},resetOrderInfo:function(){var e=GLOBAL.orderInfo.taobao;GLOBAL.orderInfo=$.extend({},GLOBAL.orderInfo_temp),GLOBAL.orderInfo.taobao=e,GLOBAL.orderInfo.orderID=Utils.newGuid().ToString("D"),GLOBAL.orderInfo.isNew=!0},popupAddTextEv:function(){function e(e,o,r,n,a,s,l,c){$("#popup-addtxt").find(".popup-title").text(e),$("#txt-info").val(c||"").css({color:"#"+r}),$("#txt-result").hide(),$("#range-font-size").val(n),$("#ttf-color").css("background","#"+r),$("#ttf-size").text(n),$("#ttf-name").text(a),$("#"+$("#ttf-pic-list").data("currSelectedId")).css("border-color","#ccc"),l?$("#del-currTxt").show():$("#del-currTxt").hide(),$("#btn-createTxt").text(o),i.str=encodeURIComponent(c||""),i.color=r,i.v=s||0,i.fontname=encodeURIComponent(a),i.size=Math.round(n/t.currPageScale)}var t=this.options,o=20,i={str:"",v:0,scale:1,color:"000000",fontname:encodeURIComponent("微软雅黑"),size:0},r=($.extend({},i),new Powerange($("#size-range .js-step")[0],{step:2,min:8,max:50,start:20,hideRange:!0}));console.log(r),document.getElementById("txt-result").addEventListener("touchmove",function(e){e.preventDefault()},!1),$("#addTxt").on("click",function(){if($("#popup-addtxt").addClass("active"),!t.ttfPicList.length){$.ajax({url:GLOBAL.reqURL.proxyURL,data:{url:GLOBAL.reqURL.ttfURL},async:!1,type:"POST",success:function(e){var o=$.xml2json(e),i=[];if(o.font.length){for(var r=0,n=o.font.length;n>r;r+=1)i.push('<li class="ttf-pic" data-ttfid="'+o.font[r].id+'" id="t-'+o.font[r].id+'"><img src="'+o.font[r].picurl+'" alt="'+o.font[r].fontname+'"></li>');for(var a=0,s=0,n=i.length;n>s;s+=1)(s+1)%6===0?(t.ttfPicList[(s+1)/6-1]={content:'<ul class="ttf-item">'+i.slice(a,s+1).join("")+"</ul>"},a=s+1):s===i.length-1&&s%6!==0&&t.ttfPicList.push({content:'<ul class="ttf-item">'+i.slice(a).join("")+"</ul>"});console.log(t.ttfPicList)}}});{new iSlider({data:t.ttfPicList,type:"dom",dom:document.getElementById("ttf-pic-list"),duration:2e3,isVertical:!1,isLooping:!0,isDebug:!1,isAutoplay:!1})}}e("添加文字","添加到模板","000000",20,"微软雅黑",0,!1)}),$("#ttf-pic-list").on("click","li.ttf-pic",function(){var e=$(this),t=e.data("ttfid"),o=e.children().first().prop("alt"),i=$("#ttf-pic-list").data("currSelectedId");$("#ttf-pic-list").data("currSelectedId","t-"+t),i&&$("#"+i).css("border-color","#ccc"),e.css("border-color","#007AFF"),$("#ttf-name").text(o)}),$("#range-font-size").on("change",function(){var e=$(this).val();$("#ttf-size").text(e),i.size=Math.round(e/t.currPageScale),o=e}),$("#ttf-color").on("click",function(){var e=this,t=$(this).css("backgroundColor");t=Utils.rgbToHex(t),console.log(t),$("#picker-box").colorPicker({colorBgSrc:"/images/colorwheel.png",currColor:t,onConfirm:function(t){$("#txt-info").css("color",t),i.color=t.substring(1),$(e).css("background-color",t)}})}),$("#btn-createTxt").on("click",function(){$("#txt-result").hide();var e=$.trim($("#txt-info").val());if(""==e)return $.msg.alert("文字输入不能为空！","#alert-box",4e3),!1;i.str=encodeURIComponent(e),i.fontname=encodeURIComponent($("#ttf-name").text());var r=GLOBAL.reqURL.getFontPicURL+Utils.objectToUrlpms(i)+"&r="+Math.random().toString().substring(3,6);console.log(r),$("#progressbar-img").show().addClass("active"),$("#txt-preimg").attr("src",r).off().load(function(){console.log("img: "+this.width+","+this.height),$("#progressbar-img").hide().removeClass("active");var e=$(this),r=this.width,n=this.height,a=$("#tpl-edit-box"+t.currPageNum),s="t-"+t.currPageNum+"-"+Math.random().toString().substring(3,5);t.textLayerInfo[s]={IsText:!0,Type:"text",Src:decodeURI(i.str),Width:r,Height:n,X:0,Y:0,FontSize:i.size,FontColor:i.color,FontFamily:decodeURI(i.fontname),size:o},e.clone().attr("id",s).addClass("txtImg").appendTo($("#tpl-edit-box"+t.currPageNum)).css({position:"absolute",top:(a.outerHeight()-t.textLayerInfo[s].Height)/2,left:(a.outerWidth()-t.textLayerInfo[s].Width)/2,"z-index":20}),t.textLayerInfo[s].X=$("#"+s).offset().left,t.textLayerInfo[s].Y=$("#"+s).offset().top,t.textLayerInfo=Utils.refreshStringArr(t.textLayerInfo),console.log(t.textLayerInfo),$("#popup-addtxt").removeClass("active"),$("#tpls-box .txtImg").pep({useCSSTranslation:!1,constrainTo:"parent",isTextZoom:!0,shouldPreventDefault:!1,activeClass:"",stop:function(e,o){var i=o.$el.attr("id");
t.textLayerInfo[i].X=o.$el.position().left,t.textLayerInfo[i].Y=o.$el.position().top,console.log(t.textLayerInfo)}}),"确认修改"==$("#btn-createTxt").text()&&$("#del-currTxt button").trigger("click")})}),$("#popup-addtxt .popup-hd").find("[data-popup-close]").on("click",function(){$("#popup-addtxt").removeClass("active")}),touch.on("#tpls-box","doubletap",".txtImg",function(){var o=$("#popup-addtxt"),i=$(this).attr("id");$("#del-currTxt").show().data("txtImgId",i),e("修改文字","确认修改",t.textLayerInfo[i].FontColor,t.textLayerInfo[i].size,t.textLayerInfo[i].FontFamily,0,!0,t.textLayerInfo[i].Src),o.addClass("active")}),$("#del-currTxt").on("click","button",function(){var e=$("#del-currTxt").data("txtImgId");t.textLayerInfo[e]=null,t.textLayerInfo=Utils.refreshStringArr(t.textLayerInfo),$("#popup-addtxt").removeClass("active"),$("#"+e).off().remove()})}},$(function(){$("#index-title").text(PRO_INFO.name+"定制主页");var e=$("#dialog-login");$("#index-ok").click(function(){if(!GLOBAL.orderInfo.tplID)return $.msg.alert("请选择一个模板！","#alert-box",4e3,"yellow"),!1;if(""!==$.trim(GLOBAL.orderInfo.taobao))return $.pageTransition.nextPage($("#view-page-index")),!1;$(this);e.addClass("active");var t=$("."+$(this).data("modal"));t.css({display:"block"}),setTimeout(function(){t.addClass("modal-in")},100),e.find(".btn-cancel").click(function(){return modalHidden(e),!1}),e.find(".btn-primary").click(function(){var t=$.trim($("#userName").val());return""!==t?(GLOBAL.orderInfo.taobao=t,Utils.setCookie("taobao",t,30),$("#userName").removeClass("ipt-error"),modalHidden(e),setTimeout(function(){$.pageTransition.nextPage($("#view-page-index"))},110),!1):($("#userName").addClass("ipt-error"),$("#userName")[0].addEventListener("webkitAnimationEnd",function(){$(this).removeClass("ipt-error")},!1),!1)}),e.click(function(t){t.target.classList.contains("overlay")&&modalHidden(e)})}),$("#txt_editTB")[0].addEventListener("webkitAnimationEnd",function(){$(this).removeClass("ipt-error")},!1),$.pageTransition.defauts.nextHandler=function(e,t){"cart"===t.data("role")?Page.cart.init():"order"===t.data("role")&&Page.order.init()},$.pageTransition.init(),Page.preInit(),Page.index.init()});